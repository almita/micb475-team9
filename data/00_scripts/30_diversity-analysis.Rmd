---
title: "Diversity Analysis"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
      smooth_scroll: true
---

# Diversity Analysis
Import libraries and data
```{r}
library(phyloseq)
library(ape)
library(tidyverse)
library(picante)
```

```{r}
starch <- read_rds("../21_phyloseq/starch_rarefied_phyloseq.RDS")
```

Separate human and mouse for the independent analysis
```{r}
human <- subset_samples(starch, cohort == "human")
mouse <- subset_samples(starch, cohort == "mouse")
```

```{r}
pal <- c("#DD4124FF", "#faa478", "#6ac1de", "#0269a1FF")
pal2 <- c("#00346EFF", "#007CBFFF", "#06ABDFFF", "#EDD03EFF", "#F5A200FF", "#6D8600FF", "#424D0CFF")
```


## Alpha diversity

```{r}
richness <- estimate_richness(starch)
rownames(richness) <- rownames(starch@sam_data)
```

```{r}
starch_rich <- merge(starch@sam_data, richness, by = 0) %>% rename(sample_id = Row.names)
```

WIP:
```{r}
otu <- otu_table(starch) %>% as.matrix() 
```

```{r}
data_evenness <- diversity(otu) / log(specnumber(otu))
```


### Shannon
#### Kruskal-Wallis
```{r}
shannon_kw <- kruskal.test(Shannon ~ group, data = starch_rich)
shannon_kw

if (shannon_kw$p.value < 0.05){
	pairwise.wilcox.test(starch_rich$Shannon, starch_rich$group, 
                       p.adjust = "bonferroni")
}
```
There is a significant difference (p-val < 0.05) in the Shannon index between  mouse-C & human-C, mouse-C & human-RS, and mouse-RS & human-RS.

- _I could also run tests to see the individual differences between cohort and treatments_

#### Plot
```{r}
starch_rich %>% ggplot(aes(group, Shannon)) +
	geom_boxplot(aes(fill = group)) +
	scale_fill_manual(values = pal) +
	ylab("Shannon Index") +
	xlab("Group") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
		legend.position = "none"
	)
```

### Faith's Phylogenetic Diversity 
```{r}
phylo_dist <- pd(t(otu_table(starch)), phy_tree(starch),
                 include.root=F) 

# add PD to metadata table
starch_rich$PD <- phylo_dist$PD
```

#### Kruskal-Wallis
```{r}
pd_kw <- kruskal.test(PD ~ group, data = starch_rich)
pd_kw

if (pd_kw$p.value < 0.05){
	pairwise.wilcox.test(starch_rich$PD, starch_rich$group, 
                       p.adjust = "bonferroni")
}
```
There is no significant difference in Faith's phylogenetic distance between the groups.

#### Plot

```{r}
ggplot(sample_data(starch_rich), aes(group, PD)) + 
	geom_boxplot(aes(fill = group)) +
	scale_fill_manual(values = pal) +
  xlab("Group") +
  ylab("Phylogenetic Diversity") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
		legend.position = "none"
	)
```

## Beta Diversity
```{r}
starchdf <- as.data.frame(sample_data(starch))
humandf <- as.data.frame(sample_data(human))
mousedf <- as.data.frame(sample_data(mouse))
```

### Bray Curtis

#### Merged
```{r}
bc_dm <- distance(starch, method="bray")
adonis2(bc_dm ~ group, data = data.frame(starchdf))
```
There is a significant difference between groups.

```{r}
pcoa_bc <- ordinate(starch, method="PCoA", distance=bc_dm)
plot_ordination(starch, pcoa_bc, color = "group") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal) +
  labs(col = "Group") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)
	
```
#### Human
```{r}
human_bc_dm <- distance(human, method="bray")
adonis2(human_bc_dm ~ trt, data = data.frame(humandf))
```
There is no significant difference between treatments. 

```{r}
human_pcoa_bc <- ordinate(human, method="PCoA", distance=human_bc_dm)

plot_ordination(human, human_pcoa_bc, color = "trt") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal[1:2]) +
  labs(col = "Treatment") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)
```

#### Mouse
```{r}
mouse_bc_dm <- distance(mouse, method="bray")
adonis2(mouse_bc_dm ~ trt+starch_type, data = data.frame(mousedf))
pw <- pairwiseAdonis::pairwise.adonis2(mouse_bc_dm ~ starch_type, data = data.frame(mousedf))

print("significantly different pairs: ")
for (i in range(2,(length(pw)))){
	pair <- pw[[i]]
	if (pair$`Pr(>F)`[1] < 0.05) {
		print(names(pw)[i])
	}
}
```
There is no significant difference between treatments but there is at least two starch types with significantly different beta-diversities.  There are PTB-BEP and CKP-CTL (CTL is control). 

```{r}
mouse_pcoa_bc <- ordinate(mouse, method="PCoA", distance=mouse_bc_dm)

plot_ordination(mouse, mouse_pcoa_bc, color = "trt") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal[3:4]) +
  labs(col = "Treatment") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)

plot_ordination(mouse, mouse_pcoa_bc, color = "starch_type") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal2) +
  labs(col = "Starch Type") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)
```

### Jaccard
#### Merged
```{r}
jc_dm <- distance(starch, method = "jaccard", binary = TRUE)
adonis2(jc_dm ~ group, data = data.frame(starchdf))
```
There is a significant difference in beta diversity between groups.

```{r}
pcoa_jc <- ordinate(starch, method="PCoA", distance=jc_dm)

plot_ordination(starch, pcoa_jc, color = "group") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal) +
  labs(col = "Group") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)
	
```

#### Human
```{r}
human_jc_dm <- distance(human, method = "jaccard", binary = TRUE)
adonis2(human_jc_dm ~ trt, data = data.frame(humandf))
```
Not significantly different.

```{r}
human_pcoa_jc <- ordinate(human, method="PCoA", distance=human_jc_dm)

plot_ordination(human, human_pcoa_jc, color = "trt") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal[1:2]) +
  labs(col = "Treatment") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)
```

#### Mouse
```{r}
mouse_jc_dm <- distance(mouse, method = "jaccard", binary = TRUE)
adonis2(mouse_jc_dm ~ trt+starch_type, data = data.frame(mousedf))
pw <- pairwiseAdonis::pairwise.adonis2(mouse_jc_dm ~ starch_type, data = data.frame(mousedf))

print("significantly different pairs: ")
for (i in range(2,(length(pw)))){
	pair <- pw[[i]]
	if (pair$`Pr(>F)`[1] < 0.05) {
		print(names(pw)[i])
	}
}
```
Beta diversity is significantly different between groups and between CKP-CTL. 

```{r}
mouse_pcoa_jc <- ordinate(mouse, method="PCoA", distance=mouse_jc_dm)

plot_ordination(mouse, mouse_pcoa_jc, color = "trt") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal[3:4]) +
  labs(col = "Treatment") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)

plot_ordination(mouse, mouse_pcoa_jc, color = "starch_type") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal2) +
  labs(col = "Starch Type") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)
```

### Unweighted Unifrac

#### Merged
```{r}
uu_dm <- distance(starch, method = "unifrac")
adonis2(uu_dm ~ group, data = data.frame(starchdf))
```


```{r}
pcoa_uu <- ordinate(starch, method="PCoA", distance=uu_dm)

plot_ordination(starch, pcoa_uu, color = "group") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal) +
  labs(col = "Group") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)
	
```

#### Human
```{r}
human_uu_dm <- distance(human, method = "unifrac")
adonis2(human_uu_dm ~ trt, data = data.frame(humandf))
```
Not significantly different.

```{r}
human_pcoa_uu <- ordinate(human, method="PCoA", distance=human_uu_dm)

plot_ordination(human, human_pcoa_uu, color = "trt") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal[1:2]) +
  labs(col = "Treatment") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)
```

#### Mouse
```{r}
mouse_uu_dm <- distance(mouse, method = "unifrac")
adonis2(mouse_uu_dm ~ trt+starch_type, data = data.frame(mousedf))
pw <- pairwiseAdonis::pairwise.adonis2(mouse_uu_dm ~ starch_type, data = data.frame(mousedf))

print("significantly different pairs: ")
for (i in range(2,(length(pw)))){
	pair <- pw[[i]]
	if (pair$`Pr(>F)`[1] < 0.05) {
		print(names(pw)[i])
	}
}
```
No significant difference between treatments but there is a difference between CKP-CTL. 

```{r}
mouse_pcoa_uu <- ordinate(mouse, method="PCoA", distance=mouse_uu_dm)

plot_ordination(mouse, mouse_pcoa_uu, color = "trt") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal[3:4]) +
  labs(col = "Treatment") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)

plot_ordination(mouse, mouse_pcoa_uu, color = "starch_type") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal2) +
  labs(col = "Starch Type") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)
```

### Weighted Unifrac
#### Merged
```{r}
wu_dm <- distance(starch, method = "wunifrac")
adonis2(wu_dm ~ group, data = data.frame(starchdf))
```
Significant difference between groups. 

```{r}
pcoa_wu <- ordinate(starch, method="PCoA", distance=wu_dm)

plot_ordination(starch, pcoa_wu, color = "group") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal) +
  labs(col = "Group") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)
	
```

#### Human
```{r}
human_wu_dm <- distance(human, method = "wunifrac")
adonis2(human_wu_dm ~ trt, data = data.frame(humandf))
```


```{r}
human_pcoa_wu <- ordinate(human, method="PCoA", distance=human_wu_dm)

plot_ordination(human, human_pcoa_wu, color = "trt") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal[1:2]) +
  labs(col = "Treatment") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)
```

#### Mouse
```{r}
mouse_wu_dm <- distance(mouse, method = "wunifrac")
adonis2(mouse_wu_dm ~ trt+starch_type, data = data.frame(mousedf))
pw <- pairwiseAdonis::pairwise.adonis2(mouse_wu_dm ~ starch_type, data = data.frame(mousedf))

print("significantly different pairs: ")
for (i in range(2,(length(pw)))){
	pair <- pw[[i]]
	if (pair$`Pr(>F)`[1] < 0.05) {
		print(names(pw)[i])
	}
}
```


```{r}
mouse_pcoa_wu <- ordinate(mouse, method="PCoA", distance=mouse_wu_dm)

plot_ordination(mouse, mouse_pcoa_wu, color = "trt") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal[3:4]) +
  labs(col = "Treatment") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)

plot_ordination(mouse, mouse_pcoa_wu, color = "starch_type") +
	stat_ellipse(alpha = 0.5) +
	scale_color_manual(values = pal2) +
  labs(col = "Starch Type") +
	theme_bw() +
	theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
	)
```
